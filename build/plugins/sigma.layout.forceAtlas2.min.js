module.exports=function(sigma){"use strict";function Supervisor(t,e){_root.URL=_root.URL||_root.webkitURL,e=e||{},this.sigInst=t,this.graph=this.sigInst.graph,this.ppn=10,this.ppe=3,this.config={},this.worker=null,this.shouldUseWorker=e.worker!==!1&&webWorkers,this.workerUrl=e.workerUrl,this.runOnBackground=!!e.background,this.easing=e.easing,this.started=!1,this.running=!1,this.initWorker()}if("undefined"==typeof sigma)throw new Error("sigma is not declared");sigma.utils.pkg("sigma.layouts");var _root=this,webWorkers="Worker"in _root,eventEmitter={};sigma.classes.dispatcher.extend(eventEmitter),Supervisor.prototype.makeBlob=function(t){var e;try{e=new Blob([t],{type:"application/javascript"})}catch(r){_root.BlobBuilder=_root.BlobBuilder||_root.WebKitBlobBuilder||_root.MozBlobBuilder,e=new BlobBuilder,e.append(t),e=e.getBlob()}return e},Supervisor.prototype.graphToByteArrays=function(){var t,e,r,s=this.graph.nodes(),i=this.graph.edges(),n=s.length*this.ppn,o=i.length*this.ppe,a={};for(this.nodesByteArray=new Float32Array(n),this.edgesByteArray=new Float32Array(o),t=e=0,r=s.length;t<r;t++)a[s[t].id]=e,this.nodesByteArray[e]=s[t].x,this.nodesByteArray[e+1]=s[t].y,this.nodesByteArray[e+2]=0,this.nodesByteArray[e+3]=0,this.nodesByteArray[e+4]=0,this.nodesByteArray[e+5]=0,this.nodesByteArray[e+6]=1+this.graph.degree(s[t].id),this.nodesByteArray[e+7]=1,this.nodesByteArray[e+8]=s[t].size,this.nodesByteArray[e+9]=s[t].fixed||0,e+=this.ppn;for(t=e=0,r=i.length;t<r;t++)this.edgesByteArray[e]=a[i[t].source],this.edgesByteArray[e+1]=a[i[t].target],this.edgesByteArray[e+2]=i[t].weight||0,e+=this.ppe},Supervisor.prototype.applyLayoutChanges=function(t){for(var e=this.graph.nodes(),r=0,s=0,i=this.nodesByteArray.length;s<i;s+=this.ppn)t?(e[r].fa2_x=this.nodesByteArray[s],e[r].fa2_y=this.nodesByteArray[s+1]):(e[r].x=this.nodesByteArray[s],e[r].y=this.nodesByteArray[s+1]),r++},Supervisor.prototype.sendByteArrayToWorker=function(t){var e={action:t||"loop",nodes:this.nodesByteArray.buffer},r=[this.nodesByteArray.buffer];"start"===t&&(e.config=this.config||{},e.edges=this.edgesByteArray.buffer,r.push(this.edgesByteArray.buffer)),this.shouldUseWorker?this.worker.postMessage(e,r):_root.postMessage(e,"*")},Supervisor.prototype.start=function(){this.running||(this.running=!0,this.started?this.sendByteArrayToWorker():(this.sendByteArrayToWorker("start"),this.started=!0,eventEmitter.dispatchEvent("start")))},Supervisor.prototype.stop=function(){this.running&&(this.running=!1,eventEmitter.dispatchEvent("stop"))},Supervisor.prototype.initWorker=function(){var _this=this,workerFn=sigma.layouts.getForceAtlas2Worker();if(this.shouldUseWorker){if(this.workerUrl)this.worker=new Worker(this.workerUrl);else{var blob=this.makeBlob(workerFn);this.worker=new Worker(URL.createObjectURL(blob))}this.worker.postMessage=this.worker.webkitPostMessage||this.worker.postMessage}else eval(workerFn);this.msgName=this.worker?"message":"newCoords",this.listener=function(t){_this.nodesByteArray=new Float32Array(t.data.nodes),_this.running&&(_this.applyLayoutChanges(_this.runOnBackground),_this.sendByteArrayToWorker(),_this.runOnBackground||_this.sigInst.refresh({skipIndexation:!0})),t.data.converged&&(_this.running=!1),_this.running||(_this.killWorker(),_this.runOnBackground&&_this.easing?(_this.applyLayoutChanges(!0),eventEmitter.dispatchEvent("interpolate"),sigma.plugins.animate(_this.sigInst,{x:"fa2_x",y:"fa2_y"},{easing:_this.easing,onComplete:function(){_this.sigInst.refresh(),eventEmitter.dispatchEvent("stop")}})):(_this.applyLayoutChanges(!1),_this.sigInst.refresh(),eventEmitter.dispatchEvent("stop")))},(this.worker||document).addEventListener(this.msgName,this.listener),this.graphToByteArrays(),_this.sigInst.bind("kill",function(){sigma.layouts.killForceAtlas2()})},Supervisor.prototype.killWorker=function(){this.worker?this.worker.terminate():(_root.postMessage({action:"kill"},"*"),document.removeEventListener(this.msgName,this.listener))},Supervisor.prototype.configure=function(t){if(this.config=t,this.started){var e={action:"config",config:this.config};this.shouldUseWorker?this.worker.postMessage(e):_root.postMessage(e,"*")}};var supervisor=null;sigma.layouts.startForceAtlas2=function(t,e){return supervisor?supervisor.running||(supervisor.killWorker(),supervisor.initWorker(),supervisor.started=!1):supervisor=new Supervisor(t,e),e&&supervisor.configure(e),supervisor.start(),eventEmitter},sigma.layouts.stopForceAtlas2=function(){if(supervisor)return supervisor.stop(),supervisor},sigma.layouts.killForceAtlas2=function(){supervisor&&(supervisor.stop(),supervisor.killWorker(),supervisor=null,eventEmitter={},sigma.classes.dispatcher.extend(eventEmitter))},sigma.layouts.configForceAtlas2=function(t,e){return supervisor?supervisor.running||(supervisor.killWorker(),supervisor.initWorker(),supervisor.started=!1):supervisor=new Supervisor(t,e),supervisor.configure(e),eventEmitter},sigma.layouts.isForceAtlas2Running=function(){return!!supervisor&&supervisor.running}},module.exports=function(sigma){"use strict";function no_crush(t){var e,r,s,i=["x","y","dx","dy","old_dx","old_dy","mass","convergence","size","fixed"],n=["source","target","weight"],o=["node","centerX","centerY","size","nextSibling","firstChild","mass","massCenterX","massCenterY"];for(r=0,s=o.length;r<s;r++)e=new RegExp("rp\\(([^,]*), '"+o[r]+"'\\)","g"),t=t.replace(e,0===r?"$1":"$1 + "+r);for(r=0,s=i.length;r<s;r++)e=new RegExp("np\\(([^,]*), '"+i[r]+"'\\)","g"),t=t.replace(e,0===r?"$1":"$1 + "+r);for(r=0,s=n.length;r<s;r++)e=new RegExp("ep\\(([^,]*), '"+n[r]+"'\\)","g"),t=t.replace(e,0===r?"$1":"$1 + "+r);return t}function getWorkerFn(){var t=crush?crush(Worker.toString()):Worker.toString();return";("+t+").call(this);"}if("undefined"==typeof sigma)throw new Error("sigma is not declared");sigma.utils.pkg("sigma.layouts");var _root=this,inWebWorker=!("document"in _root),Worker=function(t){function e(){var t,e,r={},s=arguments.length;for(t=s-1;t>=0;t--)for(e in arguments[t])r[e]=arguments[t][e];return r}function r(t){var e;for(e in t)"hasOwnProperty"in t&&!t.hasOwnProperty(e)||delete t[e];return t}function s(t,e,r){r=r||{};a=t,h=e,u.nodesLength=a.length,u.edgesLength=h.length,i(r)}function i(t){u.settings=e(t,u.settings)}function n(){var t,e,r,s,i,n,o,g,d,l,c,f,y,v,w,m,k;for(r=0;r<u.nodesLength;r+=u.ppn)a[r+4]=a[r+2],a[r+5]=a[r+3],a[r+2]=0,a[r+3]=0;if(u.settings.outboundAttractionDistribution){for(d=0,r=0;r<u.nodesLength;r+=u.ppn)d+=a[r+6];d/=u.nodesLength}if(u.settings.barnesHutOptimize){var M,b,A=1/0,B=-(1/0),_=1/0,W=-(1/0);for(p=[],r=0;r<u.nodesLength;r+=u.ppn)A=Math.min(A,a[r]),B=Math.max(B,a[r]),_=Math.min(_,a[r+1]),W=Math.max(W,a[r+1]);for(p[0]=-1,p[1]=(A+B)/2,p[2]=(_+W)/2,p[3]=Math.max(B-A,W-_),p[4]=-1,p[5]=-1,p[6]=0,p[7]=0,p[8]=0,t=1,r=0;r<u.nodesLength;r+=u.ppn)for(e=0;;)if(p[e+5]>=0)M=a[r]<p[e+1]?a[r+1]<p[e+2]?p[e+5]:p[e+5]+u.ppr:a[r+1]<p[e+2]?p[e+5]+2*u.ppr:p[e+5]+3*u.ppr,p[e+7]=(p[e+7]*p[e+6]+a[r]*a[r+6])/(p[e+6]+a[r+6]),p[e+8]=(p[e+8]*p[e+6]+a[r+1]*a[r+6])/(p[e+6]+a[r+6]),p[e+6]+=a[r+6],e=M;else{if(p[e]<0){p[e]=r;break}if(p[e+5]=t*u.ppr,o=p[e+3]/2,g=p[e+5],p[g]=-1,p[g+1]=p[e+1]-o,p[g+2]=p[e+2]-o,p[g+3]=o,p[g+4]=g+u.ppr,p[g+5]=-1,p[g+6]=0,p[g+7]=0,p[g+8]=0,g+=u.ppr,p[g]=-1,p[g+1]=p[e+1]-o,p[g+2]=p[e+2]+o,p[g+3]=o,p[g+4]=g+u.ppr,p[g+5]=-1,p[g+6]=0,p[g+7]=0,p[g+8]=0,g+=u.ppr,p[g]=-1,p[g+1]=p[e+1]+o,p[g+2]=p[e+2]-o,p[g+3]=o,p[g+4]=g+u.ppr,p[g+5]=-1,p[g+6]=0,p[g+7]=0,p[g+8]=0,g+=u.ppr,p[g]=-1,p[g+1]=p[e+1]+o,p[g+2]=p[e+2]+o,p[g+3]=o,p[g+4]=p[e+4],p[g+5]=-1,p[g+6]=0,p[g+7]=0,p[g+8]=0,t+=4,M=a[p[e]]<p[e+1]?a[p[e]+1]<p[e+2]?p[e+5]:p[e+5]+u.ppr:a[p[e]+1]<p[e+2]?p[e+5]+2*u.ppr:p[e+5]+3*u.ppr,p[e+6]=a[p[e]+6],p[e+7]=a[p[e]],p[e+8]=a[p[e]+1],p[M]=p[e],p[e]=-1,b=a[r]<p[e+1]?a[r+1]<p[e+2]?p[e+5]:p[e+5]+u.ppr:a[r+1]<p[e+2]?p[e+5]+2*u.ppr:p[e+5]+3*u.ppr,M!==b){p[b]=r;break}e=M}}if(u.settings.barnesHutOptimize)for(l=u.settings.scalingRatio,r=0;r<u.nodesLength;r+=u.ppn)for(e=0;;)if(p[e+5]>=0){if(m=Math.sqrt(Math.pow(a[r]-p[e+7],2)+Math.pow(a[r+1]-p[e+8],2)),2*p[e+3]/m<u.settings.barnesHutTheta){if(c=a[r]-p[e+7],f=a[r+1]-p[e+8],u.settings.adjustSize?m>0?(k=l*a[r+6]*p[e+6]/m/m,a[r+2]+=c*k,a[r+3]+=f*k):m<0&&(k=-l*a[r+6]*p[e+6]/m,a[r+2]+=c*k,a[r+3]+=f*k):m>0&&(k=l*a[r+6]*p[e+6]/m/m,a[r+2]+=c*k,a[r+3]+=f*k),p[e+4]<0)break;e=p[e+4];continue}e=p[e+5]}else{if(p[e]>=0&&p[e]!==r&&(c=a[r]-a[p[e]],f=a[r+1]-a[p[e]+1],m=Math.sqrt(c*c+f*f),u.settings.adjustSize?m>0?(k=l*a[r+6]*a[p[e]+6]/m/m,a[r+2]+=c*k,a[r+3]+=f*k):m<0&&(k=-l*a[r+6]*a[p[e]+6]/m,a[r+2]+=c*k,a[r+3]+=f*k):m>0&&(k=l*a[r+6]*a[p[e]+6]/m/m,a[r+2]+=c*k,a[r+3]+=f*k)),p[e+4]<0)break;e=p[e+4]}else for(l=u.settings.scalingRatio,s=0;s<u.nodesLength;s+=u.ppn)for(i=0;i<s;i+=u.ppn)c=a[s]-a[i],f=a[s+1]-a[i+1],u.settings.adjustSize?(m=Math.sqrt(c*c+f*f)-a[s+8]-a[i+8],m>0?(k=l*a[s+6]*a[i+6]/m/m,a[s+2]+=c*k,a[s+3]+=f*k,a[i+2]+=c*k,a[i+3]+=f*k):m<0&&(k=100*l*a[s+6]*a[i+6],a[s+2]+=c*k,a[s+3]+=f*k,a[i+2]-=c*k,a[i+3]-=f*k)):(m=Math.sqrt(c*c+f*f),m>0&&(k=l*a[s+6]*a[i+6]/m/m,a[s+2]+=c*k,a[s+3]+=f*k,a[i+2]-=c*k,a[i+3]-=f*k));for(g=u.settings.gravity/u.settings.scalingRatio,l=u.settings.scalingRatio,r=0;r<u.nodesLength;r+=u.ppn)k=0,c=a[r],f=a[r+1],m=Math.sqrt(Math.pow(c,2)+Math.pow(f,2)),u.settings.strongGravityMode?m>0&&(k=l*a[r+6]*g):m>0&&(k=l*a[r+6]*g/m),a[r+2]-=c*k,a[r+3]-=f*k;for(l=1*(u.settings.outboundAttractionDistribution?d:1),n=0;n<u.edgesLength;n+=u.ppe)s=h[n],i=h[n+1],o=h[n+2],w=Math.pow(o,u.settings.edgeWeightInfluence),c=a[s]-a[i],f=a[s+1]-a[i+1],u.settings.adjustSizes?(m=Math.sqrt(Math.pow(c,2)+Math.pow(f,2)-a[s+8]-a[i+8]),u.settings.linLogMode?u.settings.outboundAttractionDistribution?m>0&&(k=-l*w*Math.log(1+m)/m/a[s+6]):m>0&&(k=-l*w*Math.log(1+m)/m):u.settings.outboundAttractionDistribution?m>0&&(k=-l*w/a[s+6]):m>0&&(k=-l*w)):(m=Math.sqrt(Math.pow(c,2)+Math.pow(f,2)),u.settings.linLogMode?u.settings.outboundAttractionDistribution?m>0&&(k=-l*w*Math.log(1+m)/m/a[s+6]):m>0&&(k=-l*w*Math.log(1+m)/m):u.settings.outboundAttractionDistribution?(m=1,k=-l*w/a[s+6]):(m=1,k=-l*w)),m>0&&(a[s+2]+=c*k,a[s+3]+=f*k,a[i+2]-=c*k,a[i+3]-=f*k);var E,L,x,F,S=0;if(u.settings.adjustSizes)for(r=0;r<u.nodesLength;r+=u.ppn)a[r+9]||(E=Math.sqrt(Math.pow(a[r+2],2)+Math.pow(a[r+3],2)),E>u.maxForce&&(a[r+2]=a[r+2]*u.maxForce/E,a[r+3]=a[r+3]*u.maxForce/E),L=a[r+6]*Math.sqrt((a[r+4]-a[r+2])*(a[r+4]-a[r+2])+(a[r+5]-a[r+3])*(a[r+5]-a[r+3])),x=Math.sqrt((a[r+4]+a[r+2])*(a[r+4]+a[r+2])+(a[r+5]+a[r+3])*(a[r+5]+a[r+3]))/2,F=.1*Math.log(1+x)/(1+Math.sqrt(L)),y=a[r],v=a[r+1],a[r]=a[r]+a[r+2]*(F/u.settings.slowDown),a[r+1]=a[r+1]+a[r+3]*(F/u.settings.slowDown),c=a[r],f=a[r+1],m=Math.sqrt(Math.pow(c-y,2)+Math.pow(f-v,2)),S+=m);else for(r=0;r<u.nodesLength;r+=u.ppn)a[r+9]||(L=a[r+6]*Math.sqrt((a[r+4]-a[r+2])*(a[r+4]-a[r+2])+(a[r+5]-a[r+3])*(a[r+5]-a[r+3])),x=Math.sqrt((a[r+4]+a[r+2])*(a[r+4]+a[r+2])+(a[r+5]+a[r+3])*(a[r+5]+a[r+3]))/2,F=a[r+7]*Math.log(1+x)/(1+Math.sqrt(L)),a[r+7]=Math.min(1,Math.sqrt(F*(Math.pow(a[r+2],2)+Math.pow(a[r+3],2))/(1+Math.sqrt(L)))),y=a[r],v=a[r+1],a[r]=a[r]+a[r+2]*(F/u.settings.slowDown),a[r+1]=a[r+1]+a[r+3]*(F/u.settings.slowDown),c=a[r],f=a[r+1],m=Math.sqrt(Math.pow(c-y,2)+Math.pow(f-v,2)),S+=m);u.iterations++,u.settings.autoStop&&(u.converged=u.iterations>u.settings.maxIterations||S/u.nodesLength<u.settings.avgDistanceThreshold)}function o(t){for(var e=0;e<t;e++)n();g()}var a,h,p,g,u={ppn:10,ppe:3,ppr:9,maxForce:10,iterations:0,converged:!1,settings:{linLogMode:!1,outboundAttractionDistribution:!1,adjustSizes:!1,edgeWeightInfluence:0,scalingRatio:1,strongGravityMode:!1,gravity:1,slowDown:1,barnesHutOptimize:!1,barnesHutTheta:.5,startingIterations:1,iterationsPerRender:1,maxIterations:1e3,avgDistanceThreshold:.01,autoStop:!1}};g="undefined"!=typeof window&&window.document?function(){var t;document.createEvent?(t=document.createEvent("Event"),t.initEvent("newCoords",!0,!1)):(t=document.createEventObject(),t.eventType="newCoords"),t.eventName="newCoords",t.data={nodes:a.buffer,converged:u.converged},requestAnimationFrame(function(){document.dispatchEvent(t)})}:function(){self.postMessage({nodes:a.buffer,converged:u.converged},[a.buffer])};var d=function(t){switch(t.data.action){case"start":s(new Float32Array(t.data.nodes),new Float32Array(t.data.edges),t.data.config),o(u.settings.startingIterations);break;case"loop":a=new Float32Array(t.data.nodes),o(u.settings.iterationsPerRender);break;case"config":i(t.data.config);break;case"kill":r(u),a=null,h=null,p=null,self.removeEventListener("message",d)}};self.addEventListener("message",d)},crush=null;if(inWebWorker)eval(getWorkerFn());else{if("undefined"==typeof sigma)throw new Error("sigma is not declared");sigma.layouts.getForceAtlas2Worker=getWorkerFn}};